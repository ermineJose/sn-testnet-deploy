---
- name: stop and disable antctl service for nodes
  ansible.builtin.systemd:
    name: "antctl-reset.service"
    state: stopped
    enabled: no
  become: true

- name: upgrade node binaries using antctl
  hosts: all
  tasks:
    # There is an optional delay that can be applied before the upgrade starts.
    # This is useful for when there is one node per machine.
    - name: upgrade nodes
      ansible.builtin.shell: |
        {% if pre_upgrade_delay is defined %}
        sleep {{ pre_upgrade_delay | default(0) }}
        {% endif %}
        cmd="antctl upgrade --interval={{ interval }}"
        {% if force is defined %}
        cmd="$cmd --force"
        {% endif %}
        {% if env_variables is defined %}
        cmd="$cmd --env={{ env_variables }}"
        {% endif %}
        {% if antnode_version is defined %}
        cmd="$cmd --version={{ antnode_version }}"
        {% endif %}
        eval "$cmd"
      args:
        executable: /bin/bash

- name: start and enable antctl service for nodes
  ansible.builtin.systemd:
    name: "antctl-reset.service"
    state: started
    enabled: yes
  become: true

